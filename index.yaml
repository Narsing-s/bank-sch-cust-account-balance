<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bank Transactions — Simple UI</title>
  <style>
    /* Minimal styling so it looks decent without frameworks */
    :root{--bg:#f6f7fb;--card:#fff;--muted:#6b7280;--accent:#2563eb}
    body{font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0; background:var(--bg); color:#111}
    .container{max-width:1100px;margin:28px auto;padding:18px}
    .card{background:var(--card);padding:16px;border-radius:10px;box-shadow:0 6px 18px rgba(15,23,42,0.06)}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    h1{margin:0;font-size:20px}
    .btn{display:inline-block;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
    .btn-primary{background:var(--accent);color:#fff}
    .btn-ghost{background:transparent;border:1px solid #e5e7eb}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px;border-bottom:1px solid #eef2f7;text-align:left;font-size:14px}
    th{color:var(--muted);font-weight:600;background:#fbfdff}
    .side{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
    .flex{display:flex;gap:8px;align-items:center}
    input,textarea{width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:8px}
    .preview{border-radius:8px;padding:12px;background:#fafafa;border:1px dashed #e6eefc;min-height:160px;overflow:auto}
    /* modal */
    .modal-back{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;z-index:60}
    .modal{background:#fff;padding:16px;border-radius:10px;max-width:820px;width:95%;box-shadow:0 10px 30px rgba(2,6,23,0.3)}
    .show{display:flex}
    .small{font-size:13px;color:var(--muted)}
    .toast{position:fixed;right:18px;bottom:18px;padding:10px 14px;border-radius:8px;background:#111;color:#fff}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <header>
        <div>
          <h1>Bank Transactions — Simple HTML UI</h1>
          <div class="small muted">Fetches transactions & triggers notification emails</div>
        </div>
        <div class="flex">
          <button id="btnRefresh" class="btn btn-ghost">Refresh</button>
          <button id="btnClearSel" class="btn">Clear</button>
        </div>
      </header>

      <section id="tableSection" class="card" style="padding:12px;margin-bottom:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Transactions</strong>
          <span id="rowCount" class="small muted">0 rows</span>
        </div>

        <table id="transactionsTable" aria-live="polite">
          <thead>
            <tr>
              <th>Bank</th>
              <th>Email</th>
              <th>Total Balance</th>
              <th style="width:160px">Actions</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr><td colspan="4" class="small muted">Loading...</td></tr>
          </tbody>
        </table>
      </section>

      <section class="card">
        <div style="display:grid;grid-template-columns:2fr 1fr;gap:12px">
          <div>
            <h3 style="margin:0 0 8px 0">Selected Transaction</h3>
            <div id="selDetails" class="small muted">No transaction selected. Click "Select" to load a transaction.</div>
          </div>

          <div>
            <h3 style="margin:0 0 8px 0">Prepare Email</h3>
            <label class="small muted">Recipients (comma separated)</label>
            <input id="recipients" placeholder="user@example.com" />
            <label class="small muted" style="margin-top:8px">Subject</label>
            <input id="subject" />

            <div style="display:flex;margin-top:10px;gap:8px">
              <button id="btnPreview" class="btn btn-primary">Preview</button>
              <button id="btnSend" class="btn" style="background:#10b981;color:#fff">Send Now</button>
            </div>
            <div class="small muted" style="margin-top:8px">Note: This will POST to <code>/api/send-email</code></div>
          </div>
        </div>
      </section>

      <div style="margin-top:12px" class="small muted">If things look blank, open browser console for errors (F12).</div>
    </div>
  </div>

  <!-- modal preview -->
  <div id="modal" class="modal-back">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>Email Preview</strong>
        <div>
          <button id="closeModal" class="btn btn-ghost">Close</button>
          <button id="sendFromModal" class="btn btn-primary">Send</button>
        </div>
      </div>
      <div style="margin-bottom:8px" class="small muted">To: <span id="modalTo"></span> &nbsp; | &nbsp; Subject: <span id="modalSubject"></span></div>
      <div id="modalBody" class="preview"></div>
    </div>
  </div>

  <div id="toast" class="toast" style="display:none"></div>

  <script>
    // -----------------------
    // Simple JS frontend logic
    // -----------------------
    const API_PREFIX = '/api'; // change if your backend uses a different base
    const tableBody = document.getElementById('tableBody');
    const rowCount = document.getElementById('rowCount');
    const btnRefresh = document.getElementById('btnRefresh');
    const btnClearSel = document.getElementById('btnClearSel');
    const btnPreview = document.getElementById('btnPreview');
    const btnSend = document.getElementById('btnSend');

    const recipientsEl = document.getElementById('recipients');
    const subjectEl = document.getElementById('subject');
    const selDetails = document.getElementById('selDetails');

    const modal = document.getElementById('modal');
    const modalBody = document.getElementById('modalBody');
    const modalTo = document.getElementById('modalTo');
    const modalSubject = document.getElementById('modalSubject');
    const closeModal = document.getElementById('closeModal');
    const sendFromModal = document.getElementById('sendFromModal');

    const toast = document.getElementById('toast');

    let transactions = [];
    let selected = null;

    function showToast(text, isError=false) {
      toast.style.display = 'block';
      toast.style.background = isError ? '#dc2626' : '#111827';
      toast.textContent = text;
      setTimeout(()=> toast.style.display='none', 3500);
    }

    async function fetchTransactions() {
      tableBody.innerHTML = '<tr><td colspan="4" class="small muted">Loading...</td></tr>';
      try {
        const r = await fetch(API_PREFIX + '/transactions');
        if (!r.ok) throw new Error('HTTP ' + r.status);
        transactions = await r.json();
        renderTable();
      } catch (e) {
        tableBody.innerHTML = '<tr><td colspan="4" class="small muted">Failed to load — check backend.</td></tr>';
        console.error(e);
        showToast('Failed to load transactions', true);
      }
    }

    function renderTable() {
      rowCount.textContent = transactions.length + ' rows';
      if (!transactions || transactions.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="4" class="small muted">No transactions found.</td></tr>';
        return;
      }
      tableBody.innerHTML = '';
      transactions.forEach((tx, idx) => {
        const tr = document.createElement('tr');
        const bank = tx.BANKNAME || tx.bankName || '-';
        const mail = tx.MAILLD || tx.email || '-';
        const bal = tx.TOTALBALANCE ?? tx.totalBalance ?? '0';
        tr.innerHTML = `
          <td>${escapeHtml(bank)}</td>
          <td>${escapeHtml(mail)}</td>
          <td>${escapeHtml(bal)}</td>
          <td>
            <div style="display:flex;gap:6px">
              <button data-idx="${idx}" class="btn btn-ghost btn-select">Select</button>
              <button data-idx="${idx}" class="btn btn-primary btn-preview">Preview & Send</button>
            </div>
          </td>
        `;
        tableBody.appendChild(tr);
      });
      // attach handlers
      Array.from(document.getElementsByClassName('btn-select')).forEach(bt => bt.onclick = e => {
        const i = e.currentTarget.dataset.idx;
        onSelect(transactions[i]);
      });
      Array.from(document.getElementsByClassName('btn-preview')).forEach(bt => bt.onclick = e => {
        const i = e.currentTarget.dataset.idx;
        onSelect(transactions[i]);
        openPreview();
      });
    }

    function onSelect(tx) {
      selected = tx;
      selDetails.innerHTML = `
        <div><strong>Bank:</strong> ${escapeHtml(tx.BANKNAME || tx.bankName || '')}</div>
        <div><strong>Email:</strong> ${escapeHtml(tx.MAILLD || tx.email || '')}</div>
        <div><strong>Total Balance:</strong> ${escapeHtml(tx.TOTALBALANCE ?? tx.totalBalance ?? '0')}</div>
      `;
      // prefill email inputs
      recipientsEl.value = tx.MAILLD || tx.email || '';
      subjectEl.value = `Today's Total Balance — ${tx.BANKNAME || tx.bankName || 'Bank'}`;
    }

    function escapeHtml(s) {
      if (s === undefined || s === null) return '';
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    function buildEmailHtml(tx) {
      if (!tx) return '<div>No content</div>';
      const bank = escapeHtml(tx.BANKNAME || tx.bankName || '');
      const holder = escapeHtml(tx.ACCOUNT_HOLDER || tx.account_holder || '');
      const bal = escapeHtml(tx.TOTALBALANCE ?? tx.totalBalance ?? '0');
      return `
        <div style="font-family:Arial,Helvetica,sans-serif;line-height:1.4">
          <h2 style="margin:0 0 6px 0">Bank: ${bank}</h2>
          <p><strong>Account Holder:</strong> ${holder || 'N/A'}</p>
          <p><strong>Total Balance:</strong> ${bal}</p>
          <p style="color:#6b7280;font-size:13px">As on: ${new Date().toLocaleString()}</p>
          <hr/>
          <p>This is an automated message from Bank Notifications service.</p>
        </div>
      `;
    }

    // preview handlers
    function openPreview() {
      if (!selected) { showToast('Select a transaction first', true); return; }
      const to = recipientsEl.value || selected.MAILLD || selected.email || '';
      modalTo.textContent = to;
      const subj = subjectEl.value || `Today's Total Balance — ${selected.BANKNAME || ''}`;
      modalSubject.textContent = subj;
      modalBody.innerHTML = buildEmailHtml(selected);
      modal.classList.add('show');
    }
    function closePreview() { modal.classList.remove('show'); }

    // send email
    async function sendEmailAction() {
      if (!selected) { showToast('No transaction selected', true); return; }
      const recs = (recipientsEl.value || '').split(',').map(s => s.trim()).filter(Boolean);
      if (recs.length === 0) { showToast('Provide at least one recipient', true); return; }
      const payload = {
        transactionId: selected.ID || selected.id || selected.transactionId || null,
        recipients: recs,
        subject: subjectEl.value || `Today's Total Balance — ${selected.BANKNAME || ''}`,
        bodyHtml: buildEmailHtml(selected)
      };
      try {
        const resp = await fetch(API_PREFIX + '/send-email', {
          method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
        });
        if (!resp.ok) {
          const t = await resp.text().catch(()=>null);
          throw new Error('HTTP '+resp.status + (t?(' — '+t):''));
        }
        const data = await resp.json().catch(()=>({message:'ok'}));
        showToast(data.message || 'Email sent');
        closePreview();
      } catch (err) {
        console.error(err);
        showToast('Failed to send email', true);
      }
    }

    // wire UI
    btnRefresh.onclick = () => fetchTransactions();
    btnClearSel.onclick = () => { selected = null; selDetails.innerHTML = 'No transaction selected.'; recipientsEl.value=''; subjectEl.value=''; };
    btnPreview.onclick = openPreview;
    btnSend.onclick = sendEmailAction;
    closeModal.onclick = closePreview;
    sendFromModal.onclick = sendEmailAction;

    // initial load
    fetchTransactions();

    // poll every 60s to match Mule scheduler
    setInterval(fetchTransactions, 60000);
  </script>
</body>
</html>
